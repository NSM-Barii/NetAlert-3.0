<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NetAlert 3.0 — Nodes Dashboard</title>
  <style>
    /* ===== Hacker / terminal vibe (clean, fast) ===== */
    :root{
      --bg:#020202; --panel:#0b0f0c; --ink:#b7ffcf; --muted:#6bff9a; --accent:#36ffc3;
      --chip:#05140b; --grid:#123924; --ok:#3cff6b; --warn:#ffe963; --bad:#ff4b5c;
      --border:rgba(54,255,195,.25); --shadow:0 12px 32px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:radial-gradient(1200px 600px at 90% -10%, rgba(54,255,195,.07), transparent 60%), var(--bg); color:var(--ink)}
    .container{max-width:1120px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:14px}
    h1{margin:0;font-size:clamp(18px,3vw,28px);letter-spacing:.5px;color:var(--accent);text-shadow:0 0 18px rgba(54,255,195,.25)}
    .btn{appearance:none;border:1px solid var(--accent);background:transparent;color:var(--accent);border-radius:8px;padding:10px 14px;cursor:pointer;font-weight:700}
    .btn:hover{background:var(--accent);color:#02140b}
    .card{background:linear-gradient(180deg,rgba(11,15,12,.92),rgba(5,12,8,.92));border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .toolbar{display:grid;grid-template-columns:minmax(0,1fr) auto auto auto auto;gap:10px;align-items:center;padding:12px;border-bottom:1px solid var(--border)}
    .in{width:100%;background:var(--chip);color:var(--ink);border:1px solid rgba(54,255,195,.35);border-radius:10px;padding:10px 12px;outline:none}
    .in:focus{box-shadow:0 0 0 3px rgba(54,255,195,.2)}
    label.small{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px}
    .stats{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;padding:12px}
    .stat{background:var(--chip);border:1px solid rgba(54,255,195,.22);border-radius:10px;padding:12px}
    .stat .k{font-size:22px;font-weight:800}
    .stat .l{font-size:12px;color:var(--muted)}
    .search{padding:0 12px 12px}
    .tablewrap{overflow:auto;border-top:1px solid var(--border)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;border-bottom:1px solid rgba(54,255,195,.18);font-size:14px}
    th{text-align:left;color:var(--muted);position:sticky;top:0;background:rgba(5,12,8,.98);backdrop-filter:blur(4px)}
    .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-weight:800;font-size:12px;letter-spacing:.3px}
    .online{background:rgba(60,255,107,.12);color:var(--ok);border:1px solid rgba(60,255,107,.35)}
    .offline{background:rgba(255,75,92,.12);color:var(--bad);border:1px solid rgba(255,75,92,.35)}
    .unknown{background:rgba(255,233,99,.12);color:var(--warn);border:1px solid rgba(255,233,99,.35)}
    .dot{width:8px;height:8px;border-radius:999px;background:currentColor;box-shadow:0 0 14px currentColor}
    .error{margin:10px 12px;color:#ffd4d9;background:rgba(255,75,92,.12);border:1px solid rgba(255,75,92,.35);padding:10px 12px;border-radius:10px;font-size:13px}
    .hidden{display:none}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:10px;color:var(--muted);font-size:12px;padding:10px 12px}
    .footer a{color:var(--accent);text-decoration:none}
    .footer a:hover{text-decoration:underline}
    /* scan-line subtle effect */
    .scan{position:relative}
    .scan:before{content:"";position:absolute;inset:0;background:repeating-linear-gradient(180deg,rgba(54,255,195,.03),rgba(54,255,195,.03) 1px,transparent 2px,transparent 4px);pointer-events:none}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>NetAlert 3.0 — Nodes Dashboard</h1>
      <nav>
        <a class="btn" href="https://github.com/nsm-barii/netalert-3.0" target="_blank" rel="noopener">GitHub ↗</a>
      </nav>
    </header>

    <section class="card scan">
      <div class="toolbar">
        <input id="jsonUrl" class="in" type="text" placeholder="/nodes.json" value="/nodes.json" aria-label="JSON URL" />
        <button class="btn" id="loadBtn" title="Fetch JSON now">Load</button>
        <label class="small"><input id="autoRefresh" type="checkbox" /> Auto‑refresh <small id="intervalLabel"></small></label>
        <input id="intervalSec" class="in" type="number" min="2" step="1" value="5" title="Refresh interval (seconds)" />
        <button class="btn" id="pickBtn" title="Load local file without a server">Load local…</button>
      </div>

      <div class="stats">
        <div class="stat"><div class="k" id="statOnline">–</div><div class="l">Online</div></div>
        <div class="stat"><div class="k" id="statTotal">–</div><div class="l">Total</div></div>
        <div class="stat"><div class="k" id="statUpPct">–</div><div class="l">Uptime %</div></div>
      </div>

      <div class="search"><input id="search" class="in" type="text" placeholder="Filter by IP, host, vendor, MAC…" /></div>

      <div id="error" class="error hidden"></div>

      <div class="tablewrap">
        <table id="nodesTable">
          <thead>
            <tr>
              <th>IP</th>
              <th>Host</th>
              <th>Vendor</th>
              <th>MAC</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        <div id="lastUpdated">Last update: —</div>
        <small>Developed by <strong>NSM Barii</strong> • <a href="https://github.com/nsm-barii/netalert-3.0" target="_blank" rel="noopener">github.com/nsm-barii/netalert-3.0</a></small>
      </div>

      <input id="fileInput" type="file" accept="application/json,.json" style="display:none" />
    </section>
  </div>

  <script>
    // ===== Minimal, fast JS (no deps) =====
    const $ = (s) => document.querySelector(s);
    const ui = {
      url: $('#jsonUrl'), load: $('#loadBtn'), auto: $('#autoRefresh'), int: $('#intervalSec'), il: $('#intervalLabel'),
      online: $('#statOnline'), total: $('#statTotal'), pct: $('#statUpPct'), tbody: $('#tbody'), err: $('#error'), upd: $('#lastUpdated'),
      search: $('#search'), pick: $('#pickBtn'), file: $('#fileInput')
    };

    const normStatus = (v) => {
      if (v === true || v === 1) return 'online';
      if (v === false || v === 0) return 'offline';
      if (typeof v === 'string') {
        const s = v.trim().toLowerCase();
        if (['online','on','up','alive'].includes(s)) return 'online';
        if (['offline','off','down','dead'].includes(s)) return 'offline';
      }
      return 'unknown';
    };

    function computeSummary(data){
      try{
        const nodes = data?.nodes || {};
        const keys = Object.keys(nodes);
        const total = data?.summary?.nodes_total ?? keys.length;
        const online = data?.summary?.nodes_online ?? keys.filter(k => normStatus(nodes[k]?.status) === 'online').length;
        const pct = total ? Math.round((online/total)*100) : 0;
        return { total, online, pct };
      }catch{ return { total:0, online:0, pct:0 }; }
    }

    function setSummary({total, online, pct}){
      ui.total.textContent = total;
      ui.online.textContent = online;
      ui.pct.textContent = pct + '%';
    }

    function esc(x){ return String(x).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',''':'&#39;'}[m])); }

    function badge(s){
      const cls = s === 'online' ? 'online' : (s === 'offline' ? 'offline' : 'unknown');
      const label = s[0].toUpperCase() + s.slice(1);
      return `<span class="badge ${cls}"><span class="dot"></span>${label}</span>`;
    }

    function render(data){
      const filt = ui.search.value.trim().toLowerCase();
      const rows = Object.values(data?.nodes || {})
        .map(n => ({
          ip: n.target_ip || n.ip || '',
          host: n.host || '',
          vendor: n.vendor || '',
          mac: n.target_mac || n.mac || '',
          status: normStatus(n.status)
        }))
        .filter(n => !filt || Object.values(n).some(v => String(v).toLowerCase().includes(filt)))
        .sort((a,b) => { const pr = s => s==='online'?0:s==='unknown'?1:2; const d = pr(a.status)-pr(b.status); return d!==0?d:String(a.ip).localeCompare(String(b.ip), undefined, { numeric:true }); })
        .map(n => `<tr>
          <td><code>${esc(n.ip)}</code></td>
          <td>${esc(n.host)}</td>
          <td>${esc(n.vendor)}</td>
          <td><code>${esc(n.mac)}</code></td>
          <td>${badge(n.status)}</td>
        </tr>`).join('');
      ui.tbody.innerHTML = rows || `<tr><td colspan="5" style="color:var(--muted);padding:20px;">No nodes to display.</td></tr>`;
    }

    function apply(data){
      setSummary(computeSummary(data));
      render(data);
      ui.upd.textContent = 'Last update: ' + new Date().toLocaleString();
      window.__na3 = data;
    }

    function showErr(msg){
      ui.err.textContent = msg;
      ui.err.classList.remove('hidden');
      setTimeout(() => ui.err.classList.add('hidden'), 5000);
    }

    async function load(){
      const url = ui.url.value.trim();
      if(!url) return showErr('Enter a URL (e.g., /nodes.json)');
      try{
        const res = await fetch(url + (url.includes('?')?'&':'?') + '_=' + Date.now(), { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        apply(data);
        localStorage.setItem('na3_url', url);
      }catch(e){ showErr('Failed to load JSON: ' + e.message + '. Ensure the file is served by the same server (or use "Load local…")'); }
    }

    // Auto-refresh
    let timer = null;
    function syncTimer(){
      const s = Math.max(2, parseInt(ui.int.value || '5', 10));
      ui.int.value = String(s);
      ui.il.textContent = ui.auto.checked ? `every ${s}s` : '';
      if(timer){ clearInterval(timer); timer = null; }
      if(ui.auto.checked){ timer = setInterval(load, s * 1000); }
    }

    // Local file loader (no server)
    function loadFromFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{ const data = JSON.parse(reader.result); apply(data); }
        catch(e){ showErr('Invalid JSON: ' + e.message); }
      };
      reader.readAsText(file);
    }

    // Events
    ui.load.addEventListener('click', load);
    ui.search.addEventListener('input', () => { if(window.__na3) render(window.__na3); });
    ui.auto.addEventListener('change', syncTimer);
    ui.int.addEventListener('change', syncTimer);
    ui.pick.addEventListener('click', () => ui.file.click());
    ui.file.addEventListener('change', (e) => { const f = e.target.files?.[0]; if(f) loadFromFile(f); });

    // Init
    (function init(){ const saved = localStorage.getItem('na3_url'); if(saved) ui.url.value = saved; syncTimer(); })();
  </script>
</body>
</html>
