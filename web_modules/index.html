<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>NetAlert 3.0 — Nodes Dashboard (Optimized)</title>
<style>
  :root{
    --bg:#06030a;
    --grid:#1a1030;
    --panel:#0b0614;
    --line:#2e1f4d;
    --fg:#eae4ff;
    --muted:#a899c6;
    --accent:#9b5cff;
    --accent2:#43ffd8;
    --on:#57ffb0;
    --off:#ff7691;
    --row:#0f0a1a;
    --rowHover:#140e24;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--fg);
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    background: radial-gradient(1000px 600px at 15% -10%, #0d0720, var(--bg) 60%);
    overflow-x:hidden;
  }

  /* Animated grid background (disabled in .perf) */
  .bg-grid{
    position:fixed; inset:0; z-index:-1;
    background-image:
      linear-gradient(transparent 31px, rgba(155,92,255,0.06) 32px),
      linear-gradient(90deg, transparent 31px, rgba(155,92,255,0.06) 32px);
    background-size:32px 32px, 32px 32px;
    opacity:.35;
    animation:gridMove 30s linear infinite;
  }
  @keyframes gridMove{
    0%{ transform: translate3d(0,0,0) }
    100%{ transform: translate3d(-32px,-32px,0) }
  }

  .wrap{max-width:1024px; margin:20px auto; padding:0 12px}

  header{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; padding:10px 12px}
  h1{
    margin:0; font-size:22px; letter-spacing:.3px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }

  .gh-btn a{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border:1px solid var(--line);
    border-radius:10px; color:var(--fg); text-decoration:none; background:#0a0618;
  }
  .gh-btn a:hover{ border-color:#6a44cc }

  .panel{
    border:1px solid var(--line); border-radius:12px; padding:10px;
    background: #0c0614;
  }

  .top-row{
    display:grid; gap:8px;
    grid-template-columns: 1fr auto auto auto auto;
    align-items:center; margin-bottom:10px;
  }
  input[type="text"], input[type="number"]{
    width:100%; background:#120b22; color:var(--fg); border:1px solid #3a2866; border-radius:10px; padding:8px 10px;
    outline:none;
  }
  input[type="number"]{ width:80px; text-align:center }
  button{
    background:#0f0820; color:var(--fg); border:1px solid #3a2866; border-radius:10px; padding:8px 10px; cursor:pointer;
  }
  label.small{display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted)}

  .cards{
    display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:8px;
  }
  .card{
    border:1px dashed #3a2866; border-radius:12px; padding:10px; background:#110922;
  }
  .card .label{color:var(--muted); font-size:12px; margin-bottom:2px}
  .card .val{font-size:20px; letter-spacing:.3px; color:#d9c9ff}

  .filters{display:flex; gap:8px; align-items:center; margin-bottom:8px}
  .filters select{ background:#120b22; color:var(--fg); border:1px solid #3a2866; border-radius:10px; padding:8px 10px; }

  .grid{ border:1px solid var(--line); border-radius:12px; overflow: hidden; }
  table{ width:100%; border-collapse:separate; border-spacing:0; background:#120a22; table-layout:auto; }
  th,td{ padding:10px 12px; border-bottom:1px solid #2b1d4d; white-space:nowrap; font-size:14px; text-align:left; }
  th{ color:#d9c9ff; background:#120a24; position:sticky; top:0; z-index:2; font-weight:600; }
  td{ font-weight:500; background:var(--row) }
  tr:hover td{ background:var(--rowHover) }

  .status{ display:inline-flex; align-items:center; gap:10px; padding:2px 10px; border-radius:999px; border:1px solid;
           font-size:12px; text-transform:capitalize; }
  .on{ color:var(--on); border-color:#1c503f; background:#0b1a15 }
  .off{ color:var(--off); border-color:#512a34; background:#1a0d12 }
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.on{background:var(--on)}
  .dot.off{background:var(--off)}

  footer{ display:flex; justify-content:space-between; align-items:center; color:var(--muted);
          font-size:12px; margin-top:8px; padding:0 4px; }
  .brand a{color:#d9c9ff; text-decoration:none; border-bottom:1px dotted #5b3fb0}

  /* Perf Badge + layout */
  .right{display:flex;gap:8px;align-items:center}
  .perfToggle{font-size:12px;color:#94a9a2;display:flex;align-items:center;gap:6px}
  #perfBadge{font-size:12px;color:#47e0ac;border:1px solid #1a503f;padding:4px 8px;border-radius:8px;background:#0a1613}

  /* --- HARDCORE PERF MODE --- */
  body.perf .bg-grid{display:none}
  body.perf *{ text-shadow:none !important; box-shadow:none !important; transition:none !important; animation:none !important; }
  body.perf .panel, body.perf .card, body.perf .grid, body.perf input, body.perf button, body.perf select{
    backdrop-filter:none !important; filter:none !important;
  }
  body.perf th{ position:static } /* remove sticky header cost */
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="wrap">
  <header>
    <h1>NetAlert 3.0 — Nodes Dashboard</h1>
    <div class="right">
      <div id="perfBadge">Performance Mode ON</div>
      <label class="perfToggle"><input id="perfToggle" type="checkbox" checked/> Perf mode</label>
      <div class="gh-btn">
        <a href="https://github.com/nsm-barii/netalert-3.0" rel="noopener" target="_blank">GitHub ↗</a>
      </div>
    </div>
  </header>

  <div class="panel">
    <div class="top-row">
      <input id="url" placeholder="/nodes.json" type="text" value="/nodes.json"/>
      <button id="btnLoad">Load</button>
      <label class="small"><input id="autochk" type="checkbox"/> Auto‑refresh</label>
      <input id="interval" min="2" type="number" value="5"/>
      <button id="btnLocal">Load local…</button>
      <input accept="application/json" id="file" style="display:none" type="file"/>
    </div>

    <div class="cards">
      <div class="card"><div class="label">Online</div><div class="val" id="vOnline">—</div></div>
      <div class="card"><div class="label">Total</div><div class="val" id="vTotal">—</div></div>
      <div class="card"><div class="label">Uptime %</div><div class="val" id="vUptime">—</div></div>
    </div>

    <div class="filters">
      <input id="search" placeholder="Filter by IP, host, vendor, MAC…" type="text"/>
      <select id="status">
        <option value="">All</option>
        <option value="online">Online</option>
        <option value="offline">Offline</option>
      </select>
    </div>

    <div class="grid">
      <table>
        <thead>
          <tr>
            <th>IP</th>
            <th>Host</th>
            <th>Vendor</th>
            <th>MAC</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <footer>
    <div>Last update: <span id="last">—</span></div>
    <div class="brand">Developed by <strong>NSM Barii</strong> ·
      <a href="https://github.com/nsm-barii/netalert-3.0" rel="noopener" target="_blank">github.com/nsm-barii/netalert-3.0</a>
    </div>
  </footer>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const url = $('url'), btnLoad = $('btnLoad'), btnLocal = $('btnLocal'), file = $('file');
  const autochk = $('autochk'), interval = $('interval');
  const search = $('search'), statusSel = $('status'), tbody = $('tbody');
  const vOnline = $('vOnline'), vTotal = $('vTotal'), vUptime = $('vUptime'), last = $('last');
  const perfToggle = $('perfToggle'); const badge = $('perfBadge');

  let rows = [];
  let timer = null;
  let busy = false;
  let searchTimer = null;
  let prevHash = '';
  let perfOn = true;
  let limitRows = 500; // cap rendering in perf mode for huge lists

  function setPerfUI(){
    document.body.classList.toggle('perf', perfOn);
    if (badge){
      badge.textContent = perfOn ? 'Performance Mode ON' : 'Performance Mode OFF';
      badge.style.color = perfOn ? '#47e0ac' : '#ffd166';
      badge.style.borderColor = perfOn ? '#1a503f' : '#8a6b1f';
      badge.style.background = perfOn ? '#0a1613' : '#2a1f0a';
    }
    limitRows = perfOn ? 500 : 10000; // effectively unlimited in normal
  }
  perfOn = perfToggle?.checked ?? true;
  setPerfUI();
  perfToggle?.addEventListener('change', () => { perfOn = !!perfToggle.checked; setPerfUI(); render(); });

  function normalize(data){
    let nodes = data.nodes || [];
    if (!Array.isArray(nodes)) nodes = Object.values(nodes || {});
    const list = nodes.map(n => ({
      ip: n.target_ip || n.ip || '',
      host: n.host || '',
      vendor: n.vendor || '',
      mac: n.target_mac || n.mac || '',
      status: String(n.status || '').toLowerCase()
    }));
    const online = list.filter(x => x.status === 'online').length;
    const total = list.length;
    const uptime = total ? Math.round((online/total)*100) : 0;
    return { list, online, total, uptime };
  }

  const sortOnlineFirst = arr => arr.slice().sort((a,b)=>{
    if (a.status === b.status) return (a.ip||'').localeCompare(b.ip||'');
    return a.status === 'online' ? -1 : 1;
  });

  function render(){
    const q = (search?.value || '').trim().toLowerCase();
    const sf = statusSel?.value || '';
    const filtered = rows.filter(r => {
      const hit = (r.ip + ' ' + r.host + ' ' + r.vendor + ' ' + r.mac).toLowerCase().includes(q);
      const ok = !sf || r.status === sf;
      return hit && ok;
    });
    const ordered = sortOnlineFirst(filtered);
    const limited = ordered.slice(0, limitRows);

    // single DOM write
    let html = '';
    for (const r of limited){
      const on = r.status === 'online';
      html += '<tr>' +
        '<td>'+(r.ip || '—')+'</td>' +
        '<td>'+(r.host || '—')+'</td>' +
        '<td>'+(r.vendor || '—')+'</td>' +
        '<td>'+(r.mac || '—')+'</td>' +
        '<td><span class="status '+(on?'on':'off')+'"><span class="dot '+(on?'on':'off')+'"></span>'+(on?'online':'offline')+'</span></td>' +
      '</tr>';
    }
    tbody.innerHTML = html;
  }

  function setSummary({online,total,uptime}){
    if (vOnline) vOnline.textContent = online;
    if (vTotal) vTotal.textContent = total;
    if (vUptime) vUptime.textContent = total ? (uptime + '%') : '—';
  }

  function touchLast(){ if (last) last.textContent = new Date().toLocaleString(); }

  async function loadFromUrl(u){
    if (busy) return; busy = true;
    try{
      // Use 'no-cache' so browser can return 304 if unchanged, saving work
      const resp = await fetch(u, {cache:'no-cache'});
      if (!resp.ok) throw new Error('HTTP '+resp.status);
      const data = await resp.json();

      if (perfOn){
        // cheap change detection: compare length + simple checksum of IPs
        const ipStr = (Array.isArray(data.nodes)?data.nodes:Object.values(data.nodes||{}))
          .map(n => (n.ip||n.target_ip||'') + (n.status||'')).join('|');
        const hash = ipStr.length + ':' + ipStr.slice(0,256);
        if (hash === prevHash){ touchLast(); return; }
        prevHash = hash;
      }

      const n = normalize(data);
      rows = n.list; setSummary(n); render(); touchLast();
    }catch(e){ alert('Load failed: ' + e.message); }
    finally{ busy = false; }
  }

  function loadFromFile(f){
    const rd = new FileReader();
    rd.onload = ev => {
      try{
        const data = JSON.parse(ev.target.result);
        prevHash = '';
        const n = normalize(data);
        rows = n.list; setSummary(n); render(); touchLast();
      }catch(e){ alert('Bad JSON: ' + e.message); }
    };
    rd.readAsText(f);
  }

  btnLoad?.addEventListener('click', () => loadFromUrl((url?.value || '/nodes.json').trim() || '/nodes.json'));
  url?.addEventListener('keydown', e => { if (e.key === 'Enter') btnLoad?.click(); });
  btnLocal?.addEventListener('click', () => file?.click());
  file?.addEventListener('change', e => { const f=e.target.files?.[0]; if(f) loadFromFile(f); });

  search?.addEventListener('input', () => {
    clearTimeout(searchTimer);
    const delay = perfOn ? 200 : 80;
    searchTimer = setTimeout(render, delay);
  });
  statusSel?.addEventListener('change', render);

  autochk?.addEventListener('change', () => {
    if (autochk.checked){
      const sec = Math.max(3, parseInt((interval?.value || '5'),10)); // min 3s to breathe
      timer && clearInterval(timer);
      timer = setInterval(() => btnLoad?.click(), sec*1000);
    } else { timer && clearInterval(timer); timer = null; }
  });
  interval?.addEventListener('change', () => {
    if (autochk?.checked){
      autochk.checked = false; autochk.dispatchEvent(new Event('change'));
      autochk.checked = true;  autochk.dispatchEvent(new Event('change'));
    }
  });
})();
</script>
</body>
</html>
